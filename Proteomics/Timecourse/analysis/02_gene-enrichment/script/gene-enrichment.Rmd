---
title: "Gene enrichment analysis"
author: "Simon Haugaard"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Gene enrichment analysis

## Required R libraries
```{r libraries}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("magrittr")
pacman::p_load("data.table")
pacman::p_load("clusterProfiler")

```


## Read data
```{r read_data}
# read data
dge_file <- "../../01_dge/output/dge_results.tsv.gz"
dge <- fread(dge_file)
dge[, Direction := ifelse(logFC > 0, "up", "down")]

# Read gene annotation data
geneinfo_file <- "../../../data/gene_annotation/horse_gene_annotation.tsv.gz"
geneinfo <- fread(geneinfo_file)
setnames(geneinfo, new = c("ENSEMBL", "ENSEMBLv", "Description_detailed", 
                           "Chr", "Start", "End", "Strand", "GENENAME", "ENTREZID", "Description"))

# Remove unwanted columns and duplicate entries
geneinfo <- geneinfo[, c("ENSEMBLv", "Description_detailed") := NULL]
geneinfo <- geneinfo[!duplicated(ENSEMBL), ]

# Extract GENENAME from DGE file (assuming "GeneName" column exists in DGE)
dge[, GENENAME := sub(".*_", "", GeneName)]

# Merge DGE data with gene annotation data based on GENENAME
dge <- merge(dge, geneinfo[, .(ENSEMBL, GENENAME, ENTREZID)], by = "GENENAME", all.x = TRUE)
setcolorder(dge, c("ENSEMBL", "GENENAME", "ENTREZID", setdiff(names(dge), c("ENSEMBL", "GENENAME", "ENTREZID"))))

dge[, ENTREZID := as.character(ENTREZID)]

# subset relevant contrasts
dge <- dge[Contrast %in% c("Diff_Treatment", "Diff_Disease", "Terminal_vs_Baseline_Control", "Terminal_vs_Baseline_Metformin")]

# DGE results with only valid Entrez IDs
dge_entrez <- dge[!is.na(ENTREZID),]

# significance cut-off
dge_cut <- 0.05
enrich_cut <- 0.05
```

The analysis will be performed according to following statistical cutoffs.

- *Differential gene expression:* adjusted p-value (FDR) < `r dge_cut`
- *Enrichment analysis:* adjusted p-value (Q-value) < `r enrich_cut`

# GO

We can use "ENSEMBL" IDs for **GO** enrichment analysis as the downloaded ontology information has more ENSEMBL IDs within a GO ontology more than ENTREZ (NCBI Gene) IDs. Normally, majority of ontology databases still use ENTREZ IDs. 

```{r go}
# Read & clean GO data
go_file <- "../../../data/gene_annotation/horse_GO.tsv.gz"
go <- fread(go_file)
go <- go[, c("Gene stable ID", "GO term accession", "GO term name", "GO domain")]
setnames(go, new = c("ENSEMBL", "GOID", "Description", "GOdomain"))
go <- go[GOdomain != "", ]

term2gene <- split(go[,c("GOID", "ENSEMBL")], f = go$GOdomain)
term2name <- split(go[,c("GOID", "Description")], f = go$GOdomain)
```

## ORA on non-adjusted Pvalues
```{r go_ora}
dge_split <- split(dge, f = dge$Contrast)

go_ora <- list()

for(k in c("all", "up", "down")){
  for (j in names(term2gene)){
    for (i in names(dge_split)){
      message(paste0("Running GO ORA for '", i, "'", " within ", j, " ('", k, "' genes)"))

      if(k == "all"){
        gene <- dge_split[[i]][P.Value < dge_cut,ENSEMBL]
      }else if(k == "up"){
        gene <- dge_split[[i]][P.Value < dge_cut & Direction == "up",ENSEMBL]
      }else if(k == "down"){
        gene <- dge_split[[i]][P.Value < dge_cut & Direction == "down",ENSEMBL]
      }
      
      if(length(gene) == 0){
        warning("No DEG found, skipping...\n")
        next
      }
      
      universe <- dge_split[[i]][,ENSEMBL]
      
      go_ora[[i]][[j]][[k]] <- enricher(gene = gene, 
                                     TERM2GENE = term2gene[[j]],
                                     TERM2NAME = term2name[[j]],
                                     pAdjustMethod = "BH",
                                     pvalueCutoff = 0.05, 
                                     qvalueCutoff = 0.05,
                                     minGSSize = 10, 
                                     maxGSSize = 500, 
                                     universe = universe
      )@result
      go_ora[[i]][[j]][[k]]$Contrast <- i
      go_ora[[i]][[j]][[k]]$Database <- j
      go_ora[[i]][[j]][[k]]$Direction <- k
      
    }
  }
}

go_ora_res <- do.call(rbind, go_ora %>% unlist(recursive=FALSE) %>% unlist(recursive = F)) %>% setDT
head(go_ora_res)
go_ora_res[qvalue < enrich_cut,]

#Create output data
fwrite(x = go_ora_res, file = "../output/GO_ora.tsv.gz", sep = "\t")
go_ora_split <- split(go_ora_res, f = go_ora_res$Contrast)
openxlsx::write.xlsx(x = go_ora_split, file = "../output/GO_ora.xlsx", asTable = TRUE)

aamisc::dotplotEnrich(dt = go_ora_res, 
                      topn = 10, 
                      topn.pref = "qval", 
                      qcut = enrich_cut, 
                      nchar = 60, 
                      direction = "Direction", 
                      group = "Contrast", 
                      dot = "GeneRatio", 
                      qval = "p.adjust", 
                      term.id = "ID",
                      term.name = "Description")

#Plot results without "all" direction as it seems redundant
go_ora_res <- go_ora_res %>% 
  filter(Direction != "all")
aamisc::dotplotEnrich(dt = go_ora_res, 
                      topn = 10, 
                      topn.pref = "qval", 
                      qcut = enrich_cut, 
                      nchar = 60, 
                      direction = "Direction", 
                      group = "Contrast", 
                      dot = "GeneRatio", 
                      qval = "p.adjust", 
                      term.id = "ID",
                      term.name = "Description")

# Function to plot dot plots for each contrast
plot_dotplot_for_contrast <- function(data, contrasts, topn = 10, topn.pref = "qval", qcut = enrich_cut, nchar = 60, 
                                      direction = "Direction", group = "Contrast", dot = "GeneRatio", qval = "p.adjust", 
                                      term.id = "ID", term.name = "Description") {
  for (contrast in contrasts) {
    filtered_data <- data %>% filter(Contrast == contrast)
    if (nrow(filtered_data) > 0) {
      print(aamisc::dotplotEnrich(dt = filtered_data, 
                                  topn = topn, 
                                  topn.pref = topn.pref, 
                                  qcut = qcut, 
                                  nchar = nchar, 
                                  direction = direction, 
                                  group = group, 
                                  dot = dot, 
                                  qval = qval, 
                                  term.id = term.id, 
                                  term.name = term.name))
    } else {
      message(paste("No data for contrast:", contrast))
    }
  }
}

# Example usage
# Assuming filtered_go_ora_res is your GO enrichment result data frame
contrasts <- c("Diff_Treatment", "Terminal_vs_Baseline_Control", "Terminal_vs_Baseline_Metformin")
plot_dotplot_for_contrast(data = go_ora_res, contrasts = contrasts)

```


## GSEA
```{r go_gsea}
# Initialize go_gsea list
go_gsea <- list()

# Loop through each term2gene and dge_split combination - running GSEA with pvalue cutoff of 0.1
for (j in names(term2gene)){
    for (i in names(dge_split)){
        message(paste0("Running GO GSEA for '", i, "'", " within ", j))
        
        # Prepare geneList
        geneList <- dge_split[[i]]$logFC
        names(geneList) <- dge_split[[i]]$ENSEMBL
        geneList <- sort(geneList, decreasing = TRUE)
        
        # Run GSEA
        gsea_result <- GSEA(geneList = geneList, 
                            TERM2GENE = term2gene[[j]], 
                            TERM2NAME = term2name[[j]], 
                            pvalueCutoff = 0.1,
                            minGSSize = 10, 
                            maxGSSize = 500, 
                            eps = 0, 
                            nPermSimple = 1000)@result #TODO: Set at 1mio
        
        # Check if the result is not empty
        if (nrow(gsea_result) > 0) {
            gsea_result$Contrast <- i
            gsea_result$Database <- j
        } else {
            gsea_result <- data.frame(Contrast = character(), Database = character())
        }
        
        # Store the result in the list
        go_gsea[[i]][[j]] <- gsea_result
    }
}

go_gsea_res <- do.call(rbind, go_gsea %>% unlist(recursive=FALSE)) %>% setDT
head(go_gsea_res)
go_gsea_res[qvalue < enrich_cut,]
go_gsea_res[, direction := ifelse(NES < 0, "down", "up")]

#Output data
go_gsea_res_split <- split(go_gsea_res, f = go_gsea_res$Contrast)

#openxlsx::write.xlsx(x = go_gsea_res_split, file = "../output/GO_gsea.xlsx", asTable = TRUE)
fwrite(x = go_gsea_res_split, file = "../output/go_gsea.tsv.gz", sep = "\t")

# Function to plot dot plots for each contrast
plot_dotplot_for_contrast <- function(data_split, contrasts, topn = 10, topn.pref = "qval", qcut = enrich_cut, nchar = 60, 
                                      direction = "direction", group = "Contrast", dot = "NES", qval = "qvalue", 
                                      term.id = "ID", term.name = "Description") {
  for (contrast in contrasts) {
    if (contrast %in% names(data_split)) {
      filtered_data <- data_split[[contrast]]
      if (nrow(filtered_data) > 0) {
        print(aamisc::dotplotEnrich(dt = filtered_data, 
                                    topn = topn, 
                                    topn.pref = topn.pref, 
                                    qcut = 01, 
                                    nchar = nchar, 
                                    direction = direction, 
                                    group = group, 
                                    dot = dot, 
                                    qval = qval, 
                                    term.id = term.id, 
                                    term.name = term.name))
      } else {
        message(paste("No data for contrast:", contrast))
      }
    } else {
      message(paste("Contrast not found:", contrast))
    }
  }
}

#Plotting
contrasts <- c("Diff_Treatment", "Terminal_vs_Baseline_Control", "Terminal_vs_Baseline_Metformin")
plot_dotplot_for_contrast(data_split = go_gsea_res_split, contrasts = contrasts)

```


# KEGG
## ORA
```{r kegg_ora}
KEGG_ora_upDown <- compareCluster(ENTREZID ~ Contrast + Direction, 
                             data          = dge_entrez[P.Value < dge_cut,],
                             fun           = "enrichKEGG",
                             universe      = dge_entrez[, ENTREZID],
                             organism      = "ecb",
                             pAdjustMethod = "BH",
                             pvalueCutoff  = enrich_cut,
                             qvalueCutoff  = enrich_cut)@compareClusterResult %>% setDT

KEGG_ora <- rbindlist(list(KEGG_ora_upDown))
fwrite(x = KEGG_ora, file = "../output/kegg_ora.tsv.gz", sep = "\t")

KEGG_ora_split <- split(KEGG_ora, f = KEGG_ora$Contrast)
openxlsx::write.xlsx(x = KEGG_ora_split, file = "../output/kegg_ora.xlsx", asTable = TRUE)


# Function to plot dot plots for each contrast for KEGG enrichment results
plot_dotplot_for_contrast_kegg <- function(data, contrasts, topn = 10, topn.pref = "qval", qcut = enrich_cut, nchar = 60, 
                                           direction = "Direction", group = "Contrast", dot = "GeneRatio", qval = "qvalue", 
                                           term.id = "ID", term.name = "Description") {
  for (contrast in contrasts) {
    filtered_data <- data %>% filter(Contrast == contrast)
    if (nrow(filtered_data) > 0) {
      print(aamisc::dotplotEnrich(dt = filtered_data, 
                                  topn = topn, 
                                  topn.pref = topn.pref, 
                                  qcut = qcut, 
                                  nchar = nchar, 
                                  direction = direction, 
                                  group = group, 
                                  dot = dot, 
                                  qval = qval, 
                                  term.id = term.id, 
                                  term.name = term.name))
    } else {
      message(paste("No data for contrast:", contrast))
    }
  }
}

# Example usage
# Plot
plot_dotplot_for_contrast_kegg(data = KEGG_ora, contrasts = contrasts)
```


## GSEA 
```{r kegg_gsea}
dge_split <- split(dge_entrez, f = dge_entrez$Contrast)
kegg_gsea <- list()

for (i in names(dge_split)){
  geneList <- dge_split[[i]]$logFC
  names(geneList) <- dge_split[[i]]$ENTREZID
  geneList <- sort(geneList, decreasing = TRUE)
  
  kegg_gsea[[i]] <-  gseKEGG(geneList     = geneList,
                        organism     = 'ecb',
                        pvalueCutoff = enrich_cut,
                        minGSSize = 10, 
                        maxGSSize = 500, 
                        eps = 0, 
                        nPermSimple = 10000, # TODO: set it to 1 million for robust results
                        verbose      = TRUE
                        )@result %>% setDT
  kegg_gsea[[i]][, Direction := ifelse(test = NES > 0, yes = "up", no = "down"), ]
  kegg_gsea[[i]]$Contrast <- i
}


# Function to plot dot plots for each contrast for KEGG GSEA results
plot_dotplot_for_contrast_kegg_gsea <- function(data_split, contrasts, topn = 10, topn.pref = "qval", qcut = enrich_cut, nchar = 60, 
                                                direction = "Direction", group = "Contrast", dot = "NES", qval = "qvalue", 
                                                term.id = "ID", term.name = "Description") {
  for (contrast in contrasts) {
    if (contrast %in% names(data_split)) {
      filtered_data <- data_split[[contrast]]
      if (nrow(filtered_data) > 0) {
        print(aamisc::dotplotEnrich(dt = filtered_data, 
                                    topn = topn, 
                                    topn.pref = topn.pref, 
                                    qcut = qcut, 
                                    nchar = nchar, 
                                    direction = direction, 
                                    group = group, 
                                    qval = qval, 
                                    dot = dot, 
                                    term.id = term.id, 
                                    term.name = term.name))
      } else {
        message(paste("No data for contrast:", contrast))
      }
    } else {
      message(paste("Contrast not found:", contrast))
    }
  }
}


# Plot
plot_dotplot_for_contrast_kegg_gsea(data_split = kegg_gsea, contrasts = contrasts)
```


